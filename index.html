<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Jumia SKU Finder Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;transition:background .15s,color .15s,box-shadow .15s,opacity .2s,transform .15s}
:root{
  --bg:#0f0f13;--surface:#18181f;--surface2:#22222d;--border:#2e2e3a;
  --orange:#f68b1e;--orange-dim:#c06a10;--text:#f0eee8;--text-muted:#7e7e90;
  --green:#2ecc71;--red:#e74c3c;--blue:#5b9cf6;--radius:10px;
  --mono:'Space Mono',monospace;--sans:'DM Sans',sans-serif;
}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:14px;min-height:100vh}
header{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100;flex-wrap:wrap}
header .logo{font-family:var(--mono);font-size:1.05em;font-weight:700;color:var(--orange);letter-spacing:-0.5px;white-space:nowrap}
header .logo span{color:var(--text-muted)}
.mode-toggle{display:flex;align-items:center;background:var(--surface2);border-radius:6px;padding:3px}
.mode-btn{padding:5px 14px;border-radius:4px;border:none;background:transparent;color:var(--text-muted);font-family:var(--sans);font-size:.78em;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.5px}
.mode-btn.active{background:var(--orange);color:#fff}
.spacer{flex:1}
.status-bar{display:flex;gap:10px;align-items:center;font-family:var(--mono);font-size:.72em}
.stat{display:flex;flex-direction:column;align-items:center;line-height:1.2}
.stat .val{color:var(--orange);font-weight:700;font-size:1.1em}
.stat .lbl{color:var(--text-muted);font-size:.78em;text-transform:uppercase}
.stat-sep{width:1px;height:28px;background:var(--border)}
.loader-wrap{display:none;align-items:center;gap:6px;font-size:.74em;color:var(--text-muted)}
.loader-wrap.active{display:flex}
.dot{width:5px;height:5px;border-radius:50%;background:var(--orange);animation:pulse 1.1s ease-in-out infinite}
.dot:nth-child(2){animation-delay:.18s}.dot:nth-child(3){animation-delay:.36s}
@keyframes pulse{0%,100%{opacity:.2;transform:scale(.75)}50%{opacity:1;transform:scale(1.1)}}
.app{display:grid;grid-template-columns:310px 1fr;height:calc(100vh - 54px);overflow:hidden}
.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.main{display:flex;flex-direction:column;overflow:hidden}
.s-section{padding:12px 14px;border-bottom:1px solid var(--border)}
.s-label{font-size:.68em;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);margin-bottom:7px}
.s-row{display:flex;gap:7px;margin-bottom:7px;align-items:center}
select,input[type=text],input[type=number],textarea{
  background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:var(--sans);font-size:.83em;padding:7px 9px;
  outline:none;width:100%;-webkit-appearance:none;
}
select:focus,input:focus,textarea:focus{border-color:var(--orange)}
select option{background:#22222d}
textarea{resize:vertical;min-height:72px;font-family:var(--mono);font-size:.72em;line-height:1.55}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:7px 14px;border-radius:8px;border:none;font-family:var(--sans);font-size:.8em;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.4px;white-space:nowrap}
.btn-primary{background:var(--orange);color:#fff}
.btn-primary:hover{background:var(--orange-dim)}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--orange);color:var(--orange)}
.btn-sm{padding:5px 10px;font-size:.74em}
.btn-ghost{background:transparent;color:var(--text-muted);border:1px solid var(--border)}
.btn-ghost:hover{color:var(--text);border-color:var(--text-muted)}
.btn:disabled{opacity:.35;pointer-events:none}
.btn-full{width:100%}
.filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:5px}
.filter-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px}
.tag-pill{padding:3px 9px;border-radius:20px;font-size:.7em;font-weight:700;cursor:pointer;border:1px solid var(--border);color:var(--text-muted);background:transparent;transition:all .15s}
.tag-pill.active{background:var(--orange);border-color:var(--orange);color:#fff}
.sku-outputs{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.sku-wrap{position:relative}
.sku-copy{position:absolute;top:3px;right:3px;font-size:.63em;padding:2px 7px;z-index:2}
.toolbar{display:flex;align-items:center;gap:7px;padding:9px 14px;background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap}
.kw-wrap{flex:1;min-width:150px;position:relative}
.kw-wrap input{padding-right:68px}
.kw-btn{position:absolute;right:3px;top:50%;transform:translateY(-50%);font-size:.7em;padding:4px 9px}
.products-wrap{flex:1;overflow-y:auto;padding:10px}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(162px,1fr));gap:9px}
.product-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;position:relative;transition:border-color .2s,transform .15s}
.product-card:hover{border-color:var(--orange);transform:translateY(-2px)}
.product-card .img-wrap{position:relative;background:#111;aspect-ratio:1}
.product-card img{width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity .3s}
.product-card img.loaded{opacity:1}
.badge{position:absolute;top:5px;left:5px;font-size:.63em;font-weight:700;padding:2px 6px;border-radius:4px;color:#fff}
.badge-discount{background:var(--orange)}
.badge-express{background:var(--blue);top:auto;bottom:5px;left:5px}
.badge-oos{background:var(--red)}
.badge-official{background:#6c47ff;top:5px;right:5px;left:auto}
.del-btn{position:absolute;top:4px;right:4px;width:19px;height:19px;border-radius:50%;background:rgba(0,0,0,.75);border:none;color:#fff;font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s;z-index:5}
.product-card:hover .del-btn{opacity:1}
.p-info{padding:7px}
.p-name{font-size:.74em;font-weight:500;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:3px}
.p-brand{font-size:.66em;color:var(--text-muted);margin-bottom:3px;font-family:var(--mono)}
.p-price{font-weight:700;font-size:.86em;color:var(--orange)}
.p-old{font-size:.68em;color:var(--text-muted);text-decoration:line-through;margin-left:4px}
.p-rating{font-size:.68em;color:#f9c74f;margin-top:2px}
.p-seller{font-size:.65em;color:var(--text-muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.p-sku{font-family:var(--mono);font-size:.61em;color:var(--text-muted);margin-top:5px;padding-top:5px;border-top:1px solid var(--border);word-break:break-all}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-muted);gap:10px;text-align:center;padding:40px}
.empty .icon{font-size:2.8em;opacity:.25}
.empty p{font-size:.88em;line-height:1.65;max-width:320px}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}
.toast{position:fixed;bottom:22px;right:22px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:9px 16px;font-size:.8em;color:var(--text);z-index:999;transform:translateY(70px);opacity:0;transition:all .28s}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{border-color:var(--green);color:var(--green)}
.toast.err{border-color:var(--red);color:var(--red)}
hr.div{border:none;border-top:1px solid var(--border);margin:7px 0}
.progress-bar{height:3px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-top:6px}
.progress-fill{height:100%;background:var(--orange);border-radius:3px;transition:width .3s;width:0%}
.note{font-size:.69em;color:var(--text-muted);line-height:1.5;margin-top:5px}
</style>
</head>
<body>
<header>
  <div class="logo">SKU<span>finder</span> <span style="color:var(--orange);font-size:.62em;font-family:var(--mono)">PRO</span></div>
  <div class="mode-toggle">
    <button class="mode-btn active" id="btn-find">Find</button>
    <button class="mode-btn" id="btn-preview">Preview</button>
  </div>
  <div class="spacer"></div>
  <div class="loader-wrap" id="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div><span id="loader-text">Workingâ€¦</span></div>
  <div class="status-bar">
    <div class="stat"><span class="val" id="st-a">0</span><span class="lbl" id="st-a-lbl">Page</span></div>
    <div class="stat-sep"></div>
    <div class="stat"><span class="val" id="st-b">0</span><span class="lbl" id="st-b-lbl">of Pages</span></div>
    <div class="stat-sep"></div>
    <div class="stat"><span class="val" id="st-total">0</span><span class="lbl">Products</span></div>
  </div>
</header>

<div class="app">
<div class="sidebar">
  <!-- FIND CONTROLS -->
  <div class="s-section" id="find-controls">
    <div class="s-label">Country</div>
    <select id="country">
      <option value=".com.ng" selected>Nigeria (.com.ng)</option>
      <option value=".com.eg">Egypt (.com.eg)</option>
      <option value=".sn">Senegal (.sn)</option>
      <option value=".com.tn">Tunisia (.com.tn)</option>
      <option value=".ug">Uganda (.ug)</option>
      <option value=".ma">Morocco (.ma)</option>
      <option value=".co.ke">Kenya (.co.ke)</option>
      <option value=".com.gh">Ghana (.com.gh)</option>
      <option value=".ci">Ivory Coast (.ci)</option>
      <option value=".com.dz">Algeria (.com.dz)</option>
      <option value=".co.za">South Africa (.co.za)</option>
    </select>
    <div style="margin-top:8px" class="s-label">Listing / MLP / Category URL</div>
    <input type="text" id="url-input" placeholder="https://www.jumia.com.ng/mlp-samsung-store/" />
    <div class="s-row" style="margin-top:7px">
      <input type="number" id="page-no" placeholder="Pages" min="1" value="1" style="flex:1" />
      <button class="btn btn-primary" id="find-btn">Find</button>
    </div>
    <div class="note">Parses product cards from listing HTML. Full SKUs &amp; seller info resolved from each product page in batches.</div>
    <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
  </div>

  <!-- PREVIEW CONTROLS -->
  <div class="s-section" id="preview-controls" style="display:none">
    <div class="s-label">Country</div>
    <select id="country-preview">
      <option value=".com.ng" selected>Nigeria</option>
      <option value=".com.eg">Egypt</option>
      <option value=".sn">Senegal</option>
      <option value=".com.tn">Tunisia</option>
      <option value=".ug">Uganda</option>
      <option value=".ma">Morocco</option>
      <option value=".co.ke">Kenya</option>
      <option value=".com.gh">Ghana</option>
      <option value=".ci">Ivory Coast</option>
      <option value=".com.dz">Algeria</option>
      <option value=".co.za">South Africa</option>
    </select>
    <div style="margin-top:8px" class="s-label">Paste SKUs (comma or newline separated)</div>
    <textarea id="sku-input" placeholder="SA684EL1IHRFQNAFAMZ&#10;or SKU1,SKU2,SKU3"></textarea>
    <div class="s-row" style="margin-top:7px">
      <button class="btn btn-primary btn-full" id="preview-btn">Fetch SKU Data</button>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress2"></div></div>
    <div class="note" style="margin-top:5px">Fetches data via /catalog/?q=SKU for each entry.</div>
  </div>

  <!-- FILTERS -->
  <div class="s-section">
    <div class="s-label">Filters</div>
    <div class="filter-grid">
      <select id="f-discount"><option value="0">Discountâ€¦</option><option value="1-9">Under 10%</option><option value="10-100">10%+</option><option value="20-100">20%+</option><option value="30-100">30%+</option><option value="40-100">40%+</option><option value="50-100">50%+</option><option value="60-100">60%+</option></select>
      <select id="f-rating"><option value="0">Ratingâ€¦</option><option value="0-0">No Rating</option><option value="1-5">1+ Stars</option><option value="2-5">2+ Stars</option><option value="3-5">3+ Stars</option><option value="4-5">4+ Stars</option></select>
      <select id="f-oos"><option value="0">All Items</option><option value="valid">In-Stock Only</option><option value="oos">OOS Only</option></select>
      <select id="f-category"><option value="0">Categoryâ€¦</option></select>
      <select id="f-brand"><option value="0">Brandâ€¦</option></select>
      <select id="f-seller"><option value="0">Sellerâ€¦</option></select>
    </div>
    <div class="filter-tags" id="tag-filters">
      <div class="tag-pill" data-tag="express">Express</div>
      <div class="tag-pill" data-tag="global">Global</div>
      <div class="tag-pill" data-tag="official">Official Store</div>
      <div class="tag-pill" data-tag="hasDiscount">Has Discount</div>
      <div class="tag-pill" data-tag="hasRating">Has Rating</div>
    </div>
    <hr class="div" />
    <div class="s-row">
      <span style="font-size:.74em;color:var(--text-muted);white-space:nowrap">Sort:</span>
      <select id="f-sort-field" style="flex:1"><option value="price">Price</option><option value="discount">Discount</option><option value="rating">Rating</option><option value="name">Name</option></select>
      <select id="f-sort-dir" style="flex:0.55"><option value="asc">Asc</option><option value="dsc">Desc</option></select>
    </div>
    <div class="s-row">
      <button class="btn btn-ghost btn-sm" id="btn-shuffle">Shuffle</button>
      <button class="btn btn-ghost btn-sm" id="btn-restore">Restore</button>
    </div>
  </div>

  <!-- SKU OUTPUT -->
  <div class="s-section" style="flex:1">
    <div class="s-label">SKU Output</div>
    <div class="sku-outputs">
      <div class="sku-wrap">
        <div style="font-size:.66em;color:var(--text-muted);margin-bottom:3px">Comma</div>
        <textarea id="out-comma" readonly style="min-height:60px"></textarea>
        <button class="btn btn-ghost btn-sm sku-copy" data-target="out-comma">Copy</button>
      </div>
      <div class="sku-wrap">
        <div style="font-size:.66em;color:var(--text-muted);margin-bottom:3px">Newline</div>
        <textarea id="out-newline" readonly style="min-height:60px"></textarea>
        <button class="btn btn-ghost btn-sm sku-copy" data-target="out-newline">Copy</button>
      </div>
    </div>
  </div>
</div><!-- /sidebar -->

<!-- MAIN -->
<div class="main">
  <div class="toolbar">
    <div class="kw-wrap">
      <input type="text" id="kw-input" placeholder="Filter by keywordâ€¦" />
      <button class="btn btn-primary btn-sm kw-btn" id="btn-kw">Go</button>
    </div>
    <span style="font-size:.76em;color:var(--text-muted)" id="p-count">0 products</span>
    <div style="flex:1"></div>
    <button class="btn btn-secondary btn-sm" id="btn-csv" disabled>Export CSV</button>
  </div>
  <div class="products-wrap" id="products-wrap">
    <div class="empty" id="empty-state">
      <div class="icon">ðŸ“¦</div>
      <p>Paste a Jumia listing URL and click <strong>Find</strong>, or switch to <strong>Preview</strong> mode to look up individual SKUs.</p>
    </div>
    <div class="products-grid" id="products-grid" style="display:none"></div>
  </div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
/* â”€â”€ CORS PROXY ROTATION â”€â”€ */
const PROXIES = [
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u => `https://corsproxy.io/?${encodeURIComponent(u)}`,
  u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
  u => `https://thingproxy.freeboard.io/fetch/${u}`,
];

async function proxyFetch(url, attempt) {
  attempt = attempt || 0;
  if (attempt >= PROXIES.length) throw new Error('All proxies failed for: ' + url);
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 20000);
    const r = await fetch(PROXIES[attempt](url), {signal: controller.signal});
    clearTimeout(timeout);
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const text = await r.text();
    if (!text || text.length < 200) throw new Error('Too short');
    return text;
  } catch(e) {
    return proxyFetch(url, attempt + 1);
  }
}

/* â”€â”€ STATE â”€â”€ */
const S = {
  mode: 'find',
  domain: 'https://www.jumia.com.ng',
  data: [], original: [],
  currentPage: 1, lastPage: 1,
  url: '',
  activeTags: new Set(),
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

/* â”€â”€ UI HELPERS â”€â”€ */
function toast(msg, type) {
  type = type || '';
  var el = $('#toast');
  el.textContent = msg; el.className = 'toast show ' + type;
  clearTimeout(el._t); el._t = setTimeout(function(){ el.className = 'toast'; }, 2800);
}
function setLoader(on, txt) {
  txt = txt || 'Workingâ€¦';
  $('#loader').classList.toggle('active', on);
  $('#loader-text').textContent = txt;
}
function setProgress(pct, id) {
  id = id || 'progress';
  var el = $('#' + id);
  if (el) el.style.width = Math.min(100, pct) + '%';
}
function updateStatus(a, b, total) {
  $('#st-a').textContent = a;
  $('#st-b').textContent = b;
  $('#st-total').textContent = total;
  $('#p-count').textContent = total + ' products';
}
function syncDomain(val) {
  if (val === '.co.za') { S.domain = 'https://www.zando.co.za'; }
  else { S.domain = 'https://www.jumia' + val; }
}
function escH(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function isValidUrl(s) {
  try { var u = new URL(s); return u.protocol.startsWith('http'); } catch(e) { return false; }
}
function parsePrice(s) { return parseFloat((s||'').replace(/[^0-9.]/g,'')) || 0; }

/* â”€â”€ LISTING HTML PARSER (Find Mode) â”€â”€
   Jumia listing/MLP pages render products as <article class="prd"> cards.
   Each article has an <a class="core"> inside with all product data.
   We parse these directly from the fetched HTML string.
*/
function parseListingHTML(html) {
  var parser = new DOMParser();
  var doc = parser.parseFromString(html, 'text/html');
  var products = [];
  var seen = {};

  // Primary selector: <article class="prd">
  var articles = doc.querySelectorAll('article.prd');

  // Fallback: <a class="core"> directly
  var anchors = articles.length > 0
    ? Array.from(articles).map(function(a){ return {article: a, link: a.querySelector('a.core') || a.querySelector('a[href*=".html"]')}; })
    : Array.from(doc.querySelectorAll('a.core[href*=".html"], a[href*=".html"][data-name]')).map(function(a){ return {article: null, link: a}; });

  anchors.forEach(function(pair) {
    var article = pair.article;
    var a = pair.link;
    if (!a) return;

    var href = a.getAttribute('href') || '';
    if (!href || !href.includes('.html')) return;
    if (seen[href]) return;
    seen[href] = true;

    // Extract numeric item ID from URL end: -123456789.html
    var idMatch = href.match(/-(\d+)\.html/);
    var itemId = idMatch ? idMatch[1] : '';

    // data-sku on article or link (present on some pages)
    var dataSku = (article && article.getAttribute('data-sku')) || a.getAttribute('data-sku') || '';
    var dataBrand = (article && article.getAttribute('data-brand')) || a.getAttribute('data-brand') || '';
    var dataName = a.getAttribute('data-name') || '';

    // Name: try <h3 class="name">, then <h3>, then data-name
    var nameEl = a.querySelector('h3.name') || a.querySelector('.name') || a.querySelector('h3');
    var name = nameEl ? nameEl.textContent.trim() : (dataName || '');

    // Image: look for img tag
    var imgEl = a.querySelector('img');
    var image = '';
    if (imgEl) {
      image = imgEl.getAttribute('data-src') || imgEl.getAttribute('src') || '';
      // allorigins returns raw HTML so lazy images keep data-src
    }

    // Price: class "prc" for current, "old" for old price
    var priceEl = a.querySelector('.prc');
    var oldPriceEl = a.querySelector('.old');
    var price = priceEl ? priceEl.textContent.trim() : '';
    var oldPrice = oldPriceEl ? oldPriceEl.textContent.trim() : '';

    // Discount: class "_dsct" (e.g. "-13%")
    var discEl = a.querySelector('._dsct') || a.querySelector('.dsct') || a.querySelector('[class*="dsct"]');
    var discount = '0';
    if (discEl) {
      var discText = discEl.textContent.replace(/[^0-9]/g, '');
      if (discText) discount = discText;
    }

    // Rating: class "stars _s" contains average, "._c" has review count
    var starsEl = a.querySelector('.stars._s') || a.querySelector('.stars') || a.querySelector('[class*="stars"]');
    var rating = 0;
    if (starsEl) {
      // Rating is often in a child span or as text
      var ratingText = starsEl.textContent.trim();
      var rm = ratingText.match(/[\d.]+/);
      if (rm) rating = parseFloat(rm[0]);
      // Sometimes stored as width% in style. Try data attribute too.
      var ratingData = starsEl.getAttribute('data-average') || starsEl.getAttribute('data-score');
      if (ratingData) rating = parseFloat(ratingData);
    }
    var reviewEl = a.querySelector('._c') || a.querySelector('.count') || a.querySelector('[class*="count"]');
    var reviews = 0;
    if (reviewEl) { var rev = reviewEl.textContent.replace(/[^0-9]/g,''); if(rev) reviews = parseInt(rev); }

    // OOS: look for "sold-out" class or "Out of Stock" / "Sold out" text
    var cardHTML = a.innerHTML || '';
    var cardText = a.textContent || '';
    var isOOS = a.classList.contains('out-of-stock') ||
      !!(a.querySelector('.sold-out, [class*="sold-out"], [class*="oos"]')) ||
      cardText.includes('Out of Stock') ||
      cardText.includes('Sold out') ||
      (article && article.classList.contains('_sold-out'));

    // Badges: Express, Global, Official
    var isExpress = !!(a.querySelector('._express, [class*="express"]')) ||
      cardText.includes('Jumia Express') || cardHTML.includes('express');
    var isGlobal = !!(a.querySelector('[class*="global"]')) ||
      cardText.includes('Shipped from abroad') || cardText.includes('Global');
    var isOfficial = !!(a.querySelector('[class*="official"]')) ||
      cardText.includes('Official Store');

    if (!name && !price) return; // skip non-product anchors

    products.push({
      itemId: itemId,
      sku: dataSku || itemId,  // real SKU resolved later if dataSku missing
      name: name,
      displayName: name,
      brand: dataBrand,
      image: image,
      url: href,
      fullUrl: href.startsWith('http') ? href : S.domain + href,
      prices: { price: price, oldPrice: oldPrice, discount: discount, rawPrice: price },
      rating: { average: rating, totalRatings: reviews },
      isShopExpress: isExpress,
      isShopGlobal: isGlobal,
      isOfficial: isOfficial,
      isBuyable: !isOOS,
      _oos: isOOS,
      sellerName: 'N/A',
      categories: [],
      _needsSku: !dataSku,  // true means we still need to resolve the real alpha SKU
    });
  });

  return products;
}

/* â”€â”€ CATALOG JSON PARSER (Preview / SKU resolve) â”€â”€
   /catalog/?q=SKU returns a page with window.__STORE__ JSON
   containing products array with full data.
*/
function parseCatalogHTML(html) {
  // Method 1: window.__STORE__ = {...};
  var storeMatch = html.match(/window\.__STORE__\s*=\s*(\{[\s\S]*?\});\s*<\/script>/);
  if (storeMatch) {
    try {
      var store = JSON.parse(storeMatch[1]);
      if (store.products && store.products.length) return store.products;
    } catch(e) {}
  }

  // Method 2: inline script with "products":[{...}]
  var scriptRe = /<script[^>]*>([\s\S]*?)<\/script>/gi;
  var sm;
  while ((sm = scriptRe.exec(html)) !== null) {
    var chunk = sm[1];
    if (chunk.indexOf('"products":[{') === -1) continue;
    var start = chunk.indexOf('"products":');
    var raw = '{' + chunk.substring(start);
    // Desktop: find last }]
    try {
      var ei = raw.lastIndexOf('}]');
      if (ei > -1) {
        var parsed = JSON.parse(raw.substring(0, ei + 2) + '}');
        if (parsed.products && parsed.products.length) return parsed.products;
      }
    } catch(e2) {}
    // Mobile: strip at ,"head"
    try {
      var hi = raw.indexOf(',"head"');
      var endIdx = hi > -1 ? hi - 1 : raw.length;
      var parsedM = JSON.parse(raw.substring(0, endIdx) + '}');
      if (parsedM.products && parsedM.products.length) return parsedM.products;
    } catch(e3) {}
  }
  return [];
}

/* â”€â”€ RESOLVE REAL SKU FROM PRODUCT DETAIL PAGE â”€â”€ */
async function resolveSKU(product) {
  if (!product._needsSku || !product.url) return product;
  var detailUrl = product.fullUrl || (S.domain + product.url);
  try {
    var html = await proxyFetch(detailUrl);
    var products = parseCatalogHTML(html);
    if (products.length) {
      var p = products[0];
      product.sku = p.sku || product.itemId;
      if (!product.brand && p.brand) product.brand = p.brand;
      if (p.categories && p.categories.length) product.categories = p.categories;
      if (p.sellerName) product.sellerName = p.sellerName;
      if (p.isShopExpress) product.isShopExpress = true;
      if (p.isShopGlobal) product.isShopGlobal = true;
    } else {
      // Fallback regex extractions from raw HTML
      var skuM = html.match(/"sku"\s*:\s*"([A-Z0-9]{10,30})"/);
      if (skuM) product.sku = skuM[1];
      var selM = html.match(/"sellerName"\s*:\s*"([^"]+)"/);
      if (selM) product.sellerName = selM[1];
      var brM = html.match(/"brand"\s*:\s*"([^"]+)"/);
      if (brM && !product.brand) product.brand = brM[1];
    }
  } catch(e) {
    // Keep itemId as SKU fallback â€” product still shows
  }
  product._needsSku = false;
  return product;
}

/* â”€â”€ FIND MODE â”€â”€ */
async function beginFind() {
  var urlVal = $('#url-input').value.trim();
  var pages = parseInt($('#page-no').value);
  if (!isValidUrl(urlVal)) return toast('Enter a valid URL', 'err');
  if (isNaN(pages) || pages < 1) return toast('Enter a valid page count', 'err');

  resetState();
  S.url = urlVal.split('#')[0].trimEnd().replace(/\/$/, '') + '/';
  S.lastPage = pages;
  setProgress(0); setLoader(true, 'Fetching page 1â€¦');
  updateStatus(0, pages, 0);

  for (var pg = 1; pg <= pages; pg++) {
    setLoader(true, 'Fetching page ' + pg + '/' + pages + 'â€¦');
    var sep = S.url.includes('?') ? '&' : '?';
    var pageUrl = pg === 1 ? S.url : S.url + sep + 'page=' + pg;
    try {
      var html = await proxyFetch(pageUrl);
      var parsed = parseListingHTML(html);
      parsed.forEach(function(p) { S.data.push(p); S.original.push(p); });
      setProgress((pg / pages) * 50);
      updateStatus(pg, pages, S.data.length);
    } catch(e) {
      toast('Error on page ' + pg, 'err');
    }
  }

  if (!S.data.length) {
    setLoader(false);
    toast('No products found. Check URL or proxy availability.', 'err');
    return;
  }

  // Resolve real SKUs in batches of 4
  var needsRes = S.data.filter(function(p){ return p._needsSku; });
  if (needsRes.length) {
    var batchSize = 4;
    for (var i = 0; i < needsRes.length; i += batchSize) {
      var batch = needsRes.slice(i, i + batchSize);
      await Promise.all(batch.map(function(p){ return resolveSKU(p); }));
      var done = Math.min(i + batchSize, needsRes.length);
      setProgress(50 + (done / needsRes.length) * 50);
      setLoader(true, 'Resolving SKUs ' + done + '/' + needsRes.length + 'â€¦');
    }
  }

  setProgress(100); setLoader(false);
  finalizeData();
  toast('Found ' + S.data.length + ' products!', 'ok');
}

/* â”€â”€ PREVIEW MODE â”€â”€ */
async function beginPreview() {
  var raw = $('#sku-input').value.trim();
  if (!raw) return toast('Paste some SKUs first', 'err');
  var skus = raw.split(/[\n,]+/).map(function(s){ return s.trim(); }).filter(Boolean);
  if (!skus.length) return toast('No valid SKUs found', 'err');

  resetState();
  setLoader(true, 'Fetching 0/' + skus.length + 'â€¦');
  updateStatus(0, skus.length, skus.length);
  setProgress(0, 'progress2');

  var catalogBase = S.domain + '/catalog/?q=';
  var done = 0;
  var batchSize = 4;

  for (var i = 0; i < skus.length; i += batchSize) {
    var batch = skus.slice(i, i + batchSize);
    var results = await Promise.all(batch.map(async function(sku) {
      try {
        var html = await proxyFetch(catalogBase + sku);
        var products = parseCatalogHTML(html);
        done++;
        setLoader(true, 'Fetched ' + done + '/' + skus.length + 'â€¦');
        updateStatus(done, skus.length - done, skus.length);
        setProgress((done / skus.length) * 100, 'progress2');

        if (products && products.length) {
          var p = products[0];
          p._oos = p.isBuyable === false;
          p.sellerName = p.sellerName || 'N/A';
          p.fullUrl = p.url ? S.domain + p.url : '';
          return p;
        } else {
          return makeOOS(sku);
        }
      } catch(e) {
        done++;
        return makeOOS(sku);
      }
    }));
    results.filter(Boolean).forEach(function(p){ S.data.push(p); S.original.push(p); });
  }

  setProgress(100, 'progress2'); setLoader(false);
  finalizeData();
  var live = S.data.filter(function(p){ return !p._oos; }).length;
  var oos = S.data.filter(function(p){ return p._oos; }).length;
  toast('Done! ' + live + ' live, ' + oos + ' OOS.', 'ok');
  updateStatus(live, oos, S.data.length);
  $('#st-a-lbl').textContent = 'Live';
  $('#st-b-lbl').textContent = 'OOS';
}

function makeOOS(sku) {
  return {
    sku: sku, itemId: sku, name: 'Out of Stock', displayName: 'Out of Stock',
    brand: '', image: '', url: '', fullUrl: '', sellerName: 'N/A',
    categories: [], isShopExpress: false, isShopGlobal: false, isOfficial: false,
    prices: { price: 'N/A', oldPrice: '', discount: '0', rawPrice: '0' },
    rating: { average: 0, totalRatings: 0 }, isBuyable: false, _oos: true, _needsSku: false,
  };
}

/* â”€â”€ FINALIZE â”€â”€ */
function finalizeData() {
  buildFilters(); applyFilters(); updateExport();
}

function buildFilters() {
  function uniq(arr) { return arr.filter(function(v,i,a){ return v && a.indexOf(v)===i; }); }
  var cats = uniq(S.original.map(function(p){ return p.categories && p.categories.length ? p.categories[0] : ''; }));
  var brands = uniq(S.original.map(function(p){ return p.brand||''; }).filter(function(b){ return b && b!=='N/A'; }));
  var sellers = uniq(S.original.map(function(p){ return p.sellerName||''; }).filter(function(s){ return s && s!=='N/A'; }));
  buildSelect('#f-category', cats, 'Categoryâ€¦');
  buildSelect('#f-brand', brands, 'Brandâ€¦');
  buildSelect('#f-seller', sellers, 'Sellerâ€¦');
}

function buildSelect(sel, vals, ph) {
  $(sel).innerHTML = '<option value="0">' + ph + '</option>' +
    vals.map(function(v){ return '<option value="' + escH(v) + '">' + escH(v) + '</option>'; }).join('');
}

/* â”€â”€ RENDER â”€â”€ */
function renderProducts(products) {
  var grid = $('#products-grid');
  var empty = $('#empty-state');
  $('#p-count').textContent = products.length + ' products';
  updateSKUOutput(products);
  updateExport();

  if (!products.length) {
    grid.style.display = 'none'; empty.style.display = 'flex';
    empty.querySelector('p').textContent = 'No products match the current filters.';
    return;
  }
  empty.style.display = 'none'; grid.style.display = 'grid';
  grid.innerHTML = products.map(productCardHTML).join('');

  // Lazy load
  grid.querySelectorAll('img[data-src]').forEach(function(img) {
    var io = new IntersectionObserver(function(entries) {
      entries.forEach(function(e) {
        if (!e.isIntersecting) return;
        img.src = img.dataset.src;
        img.onload = function(){ img.classList.add('loaded'); };
        img.onerror = function(){ img.classList.add('loaded'); };
        io.disconnect();
      });
    });
    io.observe(img);
  });

  // Delete buttons
  grid.querySelectorAll('.del-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault(); e.stopPropagation();
      var sku = btn.getAttribute('data-sku');
      S.data = S.data.filter(function(p){ return (p.sku||p.itemId) !== sku; });
      S.original = S.original.filter(function(p){ return (p.sku||p.itemId) !== sku; });
      btn.closest('.product-card').remove();
      updateSKUOutput(S.data);
      $('#p-count').textContent = S.data.length + ' products';
      updateExport();
    });
  });
}

function productCardHTML(p) {
  var disc = parseInt(p.prices.discount) || 0;
  var discBadge    = disc > 0 ? '<div class="badge badge-discount">-' + disc + '%</div>' : '';
  var expressBadge = p.isShopExpress ? '<div class="badge badge-express">Express</div>' : '';
  var oosBadge     = p._oos ? '<div class="badge badge-oos">OOS</div>' : '';
  var officialBadge= p.isOfficial ? '<div class="badge badge-official">Official</div>' : '';
  var rat = (p.rating && p.rating.average) ? parseFloat(p.rating.average) : 0;
  var ratingHTML = rat > 0 ? '<div class="p-rating">' + rat.toFixed(1) + ' (' + (p.rating.totalRatings||0) + ')</div>' : '';
  var sellerHTML = (p.sellerName && p.sellerName !== 'N/A') ? '<div class="p-seller">' + escH(p.sellerName) + '</div>' : '';
  var brandHTML  = (p.brand && p.brand !== 'N/A') ? '<div class="p-brand">' + escH(p.brand) + '</div>' : '';
  var imgSrc = p.image || '';
  var linkUrl = p.fullUrl || (p.url ? (S.domain + p.url) : '#');
  var sku = p.sku || p.itemId || '';
  var imgHTML = imgSrc
    ? '<img data-src="' + escH(imgSrc) + '" alt="" />'
    : '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:2em">?</div>';

  return '<div class="product-card" data-sku="' + escH(sku) + '">' +
    '<a href="' + escH(linkUrl) + '" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;display:block">' +
      '<div class="img-wrap">' + imgHTML + discBadge + expressBadge + oosBadge + officialBadge + '</div>' +
      '<div class="p-info">' +
        '<div class="p-name">' + escH(p.displayName || p.name || '') + '</div>' +
        brandHTML +
        '<div class="p-price">' + escH(p.prices.price) + '<span class="p-old">' + escH(p.prices.oldPrice||'') + '</span></div>' +
        ratingHTML + sellerHTML +
        '<div class="p-sku">' + escH(sku) + '</div>' +
      '</div>' +
    '</a>' +
    '<button class="del-btn" data-sku="' + escH(sku) + '" title="Remove">x</button>' +
  '</div>';
}

/* â”€â”€ SKU OUTPUT â”€â”€ */
function updateSKUOutput(products) {
  var skus = products.map(function(p){ return p.sku||p.itemId||''; }).filter(Boolean);
  $('#out-comma').value = skus.join(',');
  $('#out-newline').value = skus.join('\n');
  $('#st-total').textContent = products.length;
}

/* â”€â”€ FILTERS â”€â”€ */
function applyFilters() {
  var result = S.original.slice();

  var disc = $('#f-discount').value;
  if (disc !== '0') {
    var dp = disc.split('-').map(Number);
    result = result.filter(function(p){ var d = parseInt(p.prices.discount)||0; return d >= dp[0] && d <= dp[1]; });
  }

  var rating = $('#f-rating').value;
  if (rating !== '0') {
    var rp = rating.split('-').map(Number);
    result = result.filter(function(p){
      var r = parseFloat((p.rating && p.rating.average) || 0);
      if (rp[0] === 0 && rp[1] === 0) return r === 0;
      return r >= rp[0] && r <= rp[1];
    });
  }

  var oos = $('#f-oos').value;
  if (oos === 'valid') result = result.filter(function(p){ return !p._oos; });
  if (oos === 'oos')   result = result.filter(function(p){ return p._oos; });

  var cat = $('#f-category').value;
  if (cat !== '0') result = result.filter(function(p){ return p.categories && p.categories[0] === cat; });

  var brand = $('#f-brand').value;
  if (brand !== '0') result = result.filter(function(p){ return p.brand === brand; });

  var seller = $('#f-seller').value;
  if (seller !== '0') result = result.filter(function(p){ return p.sellerName === seller; });

  if (S.activeTags.has('express'))    result = result.filter(function(p){ return p.isShopExpress; });
  if (S.activeTags.has('global'))     result = result.filter(function(p){ return p.isShopGlobal; });
  if (S.activeTags.has('official'))   result = result.filter(function(p){ return p.isOfficial; });
  if (S.activeTags.has('hasDiscount'))result = result.filter(function(p){ return (parseInt(p.prices.discount)||0) > 0; });
  if (S.activeTags.has('hasRating'))  result = result.filter(function(p){ return parseFloat((p.rating&&p.rating.average)||0) > 0; });

  var field = $('#f-sort-field').value;
  var dir   = $('#f-sort-dir').value;
  result.sort(function(a, b) {
    var va, vb;
    if (field === 'price')    { va = parsePrice(a.prices.price);        vb = parsePrice(b.prices.price); }
    else if (field === 'discount') { va = parseInt(a.prices.discount)||0; vb = parseInt(b.prices.discount)||0; }
    else if (field === 'rating') { va = parseFloat((a.rating&&a.rating.average)||0); vb = parseFloat((b.rating&&b.rating.average)||0); }
    else if (field === 'name')   { return dir==='asc' ? (a.name||'').localeCompare(b.name||'') : (b.name||'').localeCompare(a.name||''); }
    else { va = 0; vb = 0; }
    return dir === 'asc' ? va - vb : vb - va;
  });

  S.data = result;
  renderProducts(S.data);
}

/* â”€â”€ KEYWORD â”€â”€ */
function filterKeyword() {
  var kw = ($('#kw-input').value||'').trim().toLowerCase();
  if (!kw) return applyFilters();
  S.data = S.original.filter(function(p) {
    return (p.displayName||p.name||'').toLowerCase().includes(kw) ||
      (p.brand||'').toLowerCase().includes(kw) ||
      (p.categories||[]).join(' ').toLowerCase().includes(kw) ||
      (p.sellerName||'').toLowerCase().includes(kw);
  });
  renderProducts(S.data);
}

/* â”€â”€ CSV EXPORT â”€â”€ */
function exportCSV() {
  var headers = ['SKU','Name','Brand','Category L1','Old Price','New Price','Discount','Express','Global','Official','Rating','Reviews','Seller','Image','URL'];
  var rows = S.data.map(function(p) {
    return [
      p.sku||p.itemId||'',
      p.displayName||p.name||'',
      p.brand||'',
      (p.categories&&p.categories[0])||'',
      p.prices.oldPrice||'',
      p.prices.price||'',
      (parseInt(p.prices.discount)||0)+'%',
      p.isShopExpress?'Yes':'No',
      p.isShopGlobal?'Yes':'No',
      p.isOfficial?'Yes':'No',
      (p.rating&&p.rating.average)||'',
      (p.rating&&p.rating.totalRatings)||'',
      p.sellerName||'',
      p.image||'',
      p.fullUrl||(p.url?S.domain+p.url:'')|'',
    ].map(function(v){ return '"' + String(v).replace(/"/g,'""') + '"'; }).join(',');
  });
  var csv = [headers.join(',')].concat(rows).join('\n');
  var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'jumia-skus-' + Date.now() + '.csv';
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
  toast('CSV exported!', 'ok');
}

function updateExport() {
  $('#btn-csv').disabled = S.data.length === 0;
}

/* â”€â”€ SHUFFLE / RESTORE â”€â”€ */
function shuffle() {
  S.data.sort(function(){ return Math.random() - 0.5; });
  renderProducts(S.data);
}
function restore() {
  S.data = S.original.slice();
  resetFiltersUI(); S.activeTags.clear();
  $$('.tag-pill').forEach(function(t){ t.classList.remove('active'); });
  applyFilters();
}
function resetFiltersUI() {
  ['#f-discount','#f-rating','#f-oos','#f-category','#f-brand','#f-seller'].forEach(function(s){
    var el = $(s); if (el) el.value = '0';
  });
  $('#kw-input').value = '';
}

/* â”€â”€ RESET STATE â”€â”€ */
function resetState() {
  S.data = []; S.original = []; S.currentPage = 1;
  $('#products-grid').innerHTML = ''; $('#products-grid').style.display = 'none';
  var es = $('#empty-state'); es.style.display = 'flex';
  es.querySelector('p').textContent = 'Fetching dataâ€¦';
  resetFiltersUI(); S.activeTags.clear();
  $$('.tag-pill').forEach(function(t){ t.classList.remove('active'); });
  updateSKUOutput([]); updateExport();
  setProgress(0); setProgress(0, 'progress2');
}

/* â”€â”€ MODE SWITCH â”€â”€ */
function setMode(mode) {
  S.mode = mode;
  $('#btn-find').classList.toggle('active', mode==='find');
  $('#btn-preview').classList.toggle('active', mode==='preview');
  $('#find-controls').style.display    = mode==='find' ? '' : 'none';
  $('#preview-controls').style.display = mode==='preview' ? '' : 'none';
  if (mode==='find') { $('#st-a-lbl').textContent='Page'; $('#st-b-lbl').textContent='of Pages'; }
  else               { $('#st-a-lbl').textContent='Live'; $('#st-b-lbl').textContent='OOS'; }
  resetState();
  $('#empty-state').querySelector('p').textContent = mode==='find'
    ? 'Paste a Jumia listing URL and click Find.'
    : 'Paste SKUs and click Fetch SKU Data.';
}

/* â”€â”€ COPY â”€â”€ */
function copyText(id) {
  var el = $('#'+id); el.select(); document.execCommand('copy');
  toast('Copied!', 'ok');
}

/* â”€â”€ BINDINGS â”€â”€ */
$('#btn-find').addEventListener('click', function(){ setMode('find'); });
$('#btn-preview').addEventListener('click', function(){ setMode('preview'); });
$('#country').addEventListener('change', function(){ syncDomain($('#country').value); $('#country-preview').value = $('#country').value; });
$('#country-preview').addEventListener('change', function(){ syncDomain($('#country-preview').value); $('#country').value = $('#country-preview').value; });
$('#find-btn').addEventListener('click', beginFind);
$('#preview-btn').addEventListener('click', beginPreview);
$('#btn-shuffle').addEventListener('click', shuffle);
$('#btn-restore').addEventListener('click', restore);
$('#btn-kw').addEventListener('click', filterKeyword);
$('#kw-input').addEventListener('keyup', function(e){ if(e.key==='Enter') filterKeyword(); });
$('#btn-csv').addEventListener('click', exportCSV);
$('#url-input').addEventListener('keyup', function(e){ if(e.key==='Enter') beginFind(); });

['#f-discount','#f-rating','#f-oos','#f-category','#f-brand','#f-seller','#f-sort-field','#f-sort-dir'].forEach(function(s){
  $(s).addEventListener('change', applyFilters);
});

$$('.tag-pill').forEach(function(pill){
  pill.addEventListener('click', function(){
    var t = pill.getAttribute('data-tag');
    if (S.activeTags.has(t)) { S.activeTags.delete(t); pill.classList.remove('active'); }
    else { S.activeTags.add(t); pill.classList.add('active'); }
    applyFilters();
  });
});

$$('.sku-copy').forEach(function(btn){
  btn.addEventListener('click', function(){ copyText(btn.getAttribute('data-target')); });
});
</script>
</body>
</html>
